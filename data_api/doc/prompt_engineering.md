# Pipeline 2 プロンプトエンジニアリング

## 改善の経緯

### 初期実装の問題点

#### 問題1: ラベル・キーワードからの誤抽出
```
メッセージ: "ラインの要約"
誤抽出: "ラインを要約したい"
```
→ 単語のみから意図を推測してしまう

#### 問題2: 1メッセージ→1Intent の固定的な対応
```
メッセージ: "AをしたいしBもしたい"
誤った抽出: "AとBをしたい" (1つにまとめられる)
正しい抽出: ["Aをしたい", "Bをしたい"] (2つに分離)
```

#### 問題3: 複数メッセージを1Intentにまとめられない
```
メッセージ1: "問題がある"
メッセージ2: "これを直したい"
誤った抽出: ["問題がある", "これを直したい"] (2つ)
正しい抽出: ["問題を修正したい"] (1つにまとめる)
```

---

## プロンプト改善（第1版 → 第2版）

### 第1版: 基本的な指示のみ

```python
prompt = f"""以下のメッセージグループから、ユーザーが「〜したい」という意図を抽出してください。

# メッセージ群
{messages_text}

# 出力形式（JSON配列）
[
  {{"summary": "意図の要約文"}}
]

# 指示
- 各意図は「〜したい」という形式で記述してください
- 複数の意図がある場合は配列で返してください
- JSON形式で返してください（他の説明は不要）
"""
```

**問題点**:
- ラベル・キーワードから誤抽出
- 1:1対応が暗黙的に想定される

---

## プロンプト改善（第2版 → 第3版）

### 第2版: 除外条件の追加

```python
# 指示
- 各意図は「〜したい」という形式で記述してください
- 複数の意図がある場合は配列で返してください
- 単なるラベル・タイトル・キーワードのみのメッセージからは意図を推測しないでください
- 具体的な行動や問題が記述されているメッセージからのみ意図を抽出してください
- 意図が明確でない場合は空配列を返してください
- JSON形式で返してください（他の説明は不要）
```

**改善点**:
- ラベル・キーワードの除外ルールを明示
- 「具体的な行動や問題」という基準を提示

**残る問題**:
- 1:1対応の固定的な想定が解消されていない

---

## 最終版（第3版）: 柔軟な対応関係

### 第3版: ルール明確化と具体例の提示

```python
prompt = f"""以下のメッセージグループから、ユーザーが「〜したい」という意図を抽出してください。

# メッセージ群
{messages_text}

# 抽出ルール
1. **1メッセージに複数の意図がある場合は、それぞれ別のIntentとして抽出してください**
   例: 「AをしたいしBもしたい」→ 2つのIntent

2. **複数メッセージで1つの意図を表現している場合は、1つのIntentにまとめてください**
   例: メッセージ1「問題Xがある」+ メッセージ2「だから解決策Yが必要」→ 1つのIntent

3. **単なるラベル・タイトル・キーワードのみのメッセージは除外してください**
   例: 「要約」「アイコン」など単語のみ → 抽出しない

4. **具体的な行動・問題・提案が記述されているメッセージからのみ抽出してください**

# 例1: 1メッセージ→2Intent
メッセージ: "直近使ったラインを一覧表示したい。それをフッターに配置したい。"
→ [
  {{"summary": "直近使ったラインを一覧表示したい"}},
  {{"summary": "直近使ったラインをフッターに配置したい"}}
]

# 例2: 2メッセージ→1Intent
メッセージ1: "状態が保存されない問題がある"
メッセージ2: "これを直したい"
→ [
  {{"summary": "状態が保存されない問題を修正したい"}}
]

# 出力形式（JSON配列のみ）
[
  {{"summary": "意図の要約文"}}
]

# 重要
- 各意図は「〜したい」という形式で記述してください
- 意図が明確でない場合は空配列を返してください
- JSON形式のみを返してください（他の説明は不要）
"""
```

---

## 改善効果

### テスト結果（50メッセージ、3グループ）

| グループ | メッセージ数 | Intent数 | 比率 | 評価 |
|---------|------------|---------|------|------|
| group_000 | 13 | 14 | 1.08 | ✅ 1メッセージ→複数Intent |
| group_003 | 2 | 2 | 1.00 | ✅ 1:1対応 |
| group_004 | 11 | 9 | 0.82 | ✅ 複数メッセージ→1Intent |

### 具体例

#### 成功例1: 1メッセージ→3Intent

**入力**:
```
直近使ってたラインの一覧という形で構造無視してリスト出すと便利そう。
しかしそれやると今の構造ブランチ一覧との棲み分けがちょっと不鮮明。
今のフッターにあるメニューをハンバーガーマーク押した時だけ出てくるものにして、
直近使ってたラインの候補をフッターに出す？
```

**出力**:
1. 直近使っていたラインを構造を無視して一覧リストとして表示したい
2. 直近使っていたラインの候補をフッターに表示したい
3. フッターのメニューをハンバーガーメニューを押した時にのみ表示したい

#### 成功例2: 1メッセージ→2Intent

**入力**:
```
ドキュメントみたいなものと考えれば、フッターからさっとコンテキスト切り替えする、の利点はかなり高く思える。
見せ方にはテキストの分量的な工夫は必要だし、メッセージごとにアイコン設定するわけにいかんからどうすんの、なところはあるけど。
コンテキストスイッチのデザイン、のパターンを調べるかなあ
```

**出力**:
1. フッターから手軽にコンテキストを切り替えられるようにしたい
2. コンテキストスイッチのデザインパターンを調査したい

#### 成功例3: 除外

**入力**: "ラインの要約"
**出力**: (抽出されない) ✅

**入力**: "単純にデータベース更新アイコン"
**出力**: (抽出されない) ✅

---

## プロンプトエンジニアリングの知見

### 効果的だったテクニック

#### 1. 番号付きルールの明確化
```
# 抽出ルール
1. **1メッセージに複数の意図がある場合は...**
2. **複数メッセージで1つの意図を表現している場合は...**
3. **単なるラベル・タイトル・キーワードのみのメッセージは...**
4. **具体的な行動・問題・提案が記述されているメッセージからのみ...**
```
→ 構造化された指示により、LLMが各ルールを明確に認識

#### 2. 具体例の提示（Few-shot Learning）
```
# 例1: 1メッセージ→2Intent
メッセージ: "..."
→ [{"summary": "..."}, {"summary": "..."}]

# 例2: 2メッセージ→1Intent
メッセージ1: "..."
メッセージ2: "..."
→ [{"summary": "..."}]
```
→ 入力と期待される出力の対応関係を具体的に示す

#### 3. 太字（Markdown）による強調
```
**1メッセージに複数の意図がある場合は、それぞれ別のIntentとして抽出してください**
```
→ 重要なポイントを視覚的に強調

#### 4. 出力形式の反復
```
# 出力形式（JSON配列）
[...]

# 出力形式（JSON配列のみ）
[...]

# 重要
- JSON形式のみを返してください（他の説明は不要）
```
→ 複数箇所で出力形式を強調することで、フォーマット違反を防止

### 効果が限定的だったテクニック

#### 1. 曖昧な指示
❌ "適切に判断してください"
✅ "単なるラベル・タイトル・キーワードのみのメッセージは除外してください"

#### 2. 否定形のみの指示
❌ "単語のみから推測しないでください"
✅ "具体的な行動・問題・提案が記述されているメッセージからのみ抽出してください"
→ 「してはいけないこと」だけでなく「すべきこと」も明示

---

## ベストプラクティス

### 1. ルールと例を両方提示する
- **ルール**: 一般的な原則を明示
- **例**: 具体的な入出力を示す
- 両方を組み合わせることで、LLMの理解が深まる

### 2. エッジケースを例に含める
- プロンプトに含まれていないケースでも推論できるよう、多様な例を提示
- 「1→2」「2→1」「除外」など、異なるパターンを網羅

### 3. 出力形式を厳格に制御
- JSON形式の例を明示
- "他の説明は不要" のように余計な出力を明示的に禁止

### 4. 段階的な改善
1. 基本的な指示
2. 除外条件の追加
3. 柔軟な対応関係の明示
→ 一度にすべてを変更せず、段階的に改善することで効果を検証

---

## まとめ

### 改善前後の比較

| 項目 | 改善前 | 改善後 |
|------|-------|-------|
| ラベル・キーワードからの誤抽出 | あり（2件） | なし（0件） |
| 1メッセージ→複数Intent | 不可 | 可能（比率1.08） |
| 複数メッセージ→1Intent | 不可 | 可能（比率0.82） |
| プロンプトの明確さ | 曖昧 | 構造化・具体例あり |

### 適用可能な他のパイプライン

この知見は Pipeline 5（Why/How関係抽出）にも適用可能：
- ルールの明確化
- 具体例の提示
- 出力形式の厳格化
