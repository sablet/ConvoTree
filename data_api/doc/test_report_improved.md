# Pipeline 1-3 テストレポート（改善版）

**生成日時**: 2025-11-05
**テストデータ**: messagees_sample.csv（最初の50件）
**主な改善**: 1メッセージ→複数Intent、複数メッセージ→1Intentに対応

---

## サマリー

| 項目 | 件数 |
|------|------|
| 入力メッセージ数 | 50 |
| 生成グループ数 | 16 |
| テスト対象グループ数 | 3（複数メッセージ含む） |
| 抽出Intent数 | 25 |

---

## プロンプト改善の経緯

### 問題点の発見
初期実装では以下の問題がありました：

1. **1メッセージ→1Intent の固定的な対応**
   - 1つのメッセージに複数の意図がある場合も1つのIntentにまとめられてしまう
   - 例: "AをしたいしBもしたい" → 1つのIntentとして扱われる

2. **複数メッセージ→複数Intent の機械的な対応**
   - 関連する複数メッセージを1つのIntentにまとめられない
   - 例: メッセージ1「問題がある」+ メッセージ2「これを直したい」→ 2つのIntentに分離

3. **ラベル・キーワードからの誤抽出**
   - "ラインの要約" → "ラインを要約したい"（誤抽出）

### プロンプト改善内容

```python
# 抽出ルール
1. **1メッセージに複数の意図がある場合は、それぞれ別のIntentとして抽出してください**
   例: 「AをしたいしBもしたい」→ 2つのIntent

2. **複数メッセージで1つの意図を表現している場合は、1つのIntentにまとめてください**
   例: メッセージ1「問題Xがある」+ メッセージ2「だから解決策Yが必要」→ 1つのIntent

3. **単なるラベル・タイトル・キーワードのみのメッセージは除外してください**
   例: 「要約」「アイコン」など単語のみ → 抽出しない

4. **具体的な行動・問題・提案が記述されているメッセージからのみ抽出してください**

# 例1: 1メッセージ→2Intent
メッセージ: "直近使ったラインを一覧表示したい。それをフッターに配置したい。"
→ [
  {"summary": "直近使ったラインを一覧表示したい"},
  {"summary": "直近使ったラインをフッターに配置したい"}
]

# 例2: 2メッセージ→1Intent
メッセージ1: "状態が保存されない問題がある"
メッセージ2: "これを直したい"
→ [
  {"summary": "状態が保存されない問題を修正したい"}
]
```

---

## テスト結果

### グループごとのメッセージ/Intent比率

| グループ | メッセージ数 | Intent数 | 比率 | 評価 |
|---------|------------|---------|------|------|
| group_000 | 13 | 14 | 1.08 | ✅ 1メッセージ→複数Intent実現 |
| group_003 | 2 | 2 | 1.00 | ✅ 1:1対応 |
| group_004 | 11 | 9 | 0.82 | ✅ 複数メッセージ→1Intent実現 |

### 改善効果の確認

#### ✅ 1メッセージ→複数Intent の成功例

**元メッセージ（ID: 1）**:
```
直近使ってたラインの一覧という形で構造無視してリスト出すと便利そう。
しかしそれやると今の構造ブランチ一覧との棲み分けがちょっと不鮮明。
今のフッターにあるメニューをハンバーガーマーク押した時だけ出てくるものにして、
直近使ってたラインの候補をフッターに出す？
```

**抽出されたIntent（3つ）**:
1. 直近使っていたラインを構造を無視して一覧リストとして表示したい
2. 直近使っていたラインの候補をフッターに表示したい
3. フッターのメニューをハンバーガーメニューを押した時にのみ表示したい

→ **1メッセージから3つの異なる意図を正しく抽出**

#### ✅ 複数メッセージ→複数Intent の柔軟な対応

**元メッセージ（ID: 4）**:
```
ドキュメントみたいなものと考えれば、フッターからさっとコンテキスト切り替えする、の利点はかなり高く思える。
見せ方にはテキストの分量的な工夫は必要だし、メッセージごとにアイコン設定するわけにいかんからどうすんの、なところはあるけど。
コンテキストスイッチのデザイン、のパターンを調べるかなあ
```

**抽出されたIntent（2つ）**:
1. フッターから手軽にコンテキストを切り替えられるようにしたい
2. コンテキストスイッチのデザインパターンを調査したい

→ **1メッセージ内の複数の関心事を適切に分離**

#### ✅ ラベル・キーワードの除外

**元メッセージ**: "ラインの要約"
**結果**: 抽出されない ✅

**元メッセージ**: "単純にデータベース更新アイコン"
**結果**: 抽出されない ✅

---

## 抽出されたIntent一覧

### group_000（13メッセージ → 14Intent）

1. 直近使っていたラインを構造を無視して一覧リストとして表示したい
2. 直近使っていたラインの候補をフッターに表示したい
3. フッターのメニューをハンバーガーメニューを押した時にのみ表示したい
4. ブランチからチャットへ移動した際、直近のラインに戻れるように修正したい
5. メッセージ修正時にローカルのメッセージが更新されるように修正したい
6. フッターから手軽にコンテキストを切り替えられるようにしたい
7. コンテキストスイッチのデザインパターンを調査したい
8. タスクをタグではなくメッセージタイプとしてメッセージ入力時に選択できるようにし、専用の統計確認画面でまとめて確認できるようにしたい
9. メッセージ更新時の「更新キャンセル」ボタンを、スクロールせずに見えるように左のタイムスタンプあたりに配置したい
10. 投稿形式をブランチとメッセージ間で変更できるようにしたい
11. ブランチ一覧からブランチが消えないようにしたい
12. ブランチ一覧の編集時に表示されるテキストレイアウトを改善したい
13. メッセージの編集アイコンや削除アイコンと並べて、ライン移動アイコンを作成したい
14. ラインIDを指定して、それをMCPでコーディングエージェントなどに渡せるようにしたい

### group_003（2メッセージ → 2Intent）

1. サイドバーのブランチとフッターの基準が異なっているか確認したい
2. 新しいメッセージを入れた後、一番下まで自動でスクロールするようにしたい

### group_004（11メッセージ → 9Intent）

1. ブランチがシステムメッセージとしていつ別れたのか分かるようにしたい
2. 自分の思考がどのように構造化されているかをマインドマップ的な方法で可視化したい
3. メッセージに優先度別のタスクタグと完了情報をわかりやすく追加したい
4. どうでも良い話題のチャットをこのアプリに収束させたい
5. Claude Codeとのやり取り履歴を閲覧できるようにしたい
6. 編集ボタンなどのメッセージ操作ボタンをメッセージの右下に出したい
7. テキストのコピー機能を追加したい
8. スクショ保存機能の優先度を上げたい
9. ポモドーロやタイマー機能を、ブランチに関する活動のチェックイン/チェックアウトを示すメッセージタイプで兼ねられるようにしたい

---

## Intent抽出の精度分析

### メッセージ/Intent比率の分布

- **1.08** (group_000): 1メッセージが複数Intentに分割されるケースあり
- **1.00** (group_003): 1メッセージ1Intentの対応
- **0.82** (group_004): 複数メッセージが1Intentにまとめられるケースあり

### 抽出パターン

#### ✅ 正しく抽出されたパターン
1. **複数提案を含むメッセージ**: 各提案を個別のIntentとして分離
2. **問題と解決策**: 問題指摘と解決提案を1つのIntentにまとめる
3. **具体的な実装指示**: "〜をつくる"、"〜を追加したい" など明確な行動

#### ✅ 正しく除外されたパターン
1. **単語・ラベルのみ**: "ラインの要約"、"アイコン"
2. **キーワード羅列**: 行動や問題の記述がないもの

#### 抽出品質の向上
- **改善前**: 16 Intent（誤抽出2件含む）
- **改善後**: 25 Intent（誤抽出0件、より細かい粒度で抽出）

---

## プロンプトエンジニアリングの知見

### 効果的だった指示

1. **具体例の提示**
   - "例1: 1メッセージ→2Intent" のような具体例を示すことで、LLMの挙動を制御

2. **番号付きルールの明確化**
   - ルール1, 2, 3, 4のように明確に構造化

3. **除外条件の明示**
   - "単なるラベル・タイトル・キーワードのみ" のような具体的な除外条件

4. **出力形式の強調**
   - "JSON形式のみを返してください（他の説明は不要）" で余計な出力を防止

### 柔軟性の獲得

プロンプトに含まれていない新しいケースでも適切に動作：
- 例示していない複雑な文章構造でも意図を正しく分離
- 文脈から暗黙的な意図を適切に補完

---

## 結論

プロンプト改善により、Intent抽出の精度と柔軟性が大幅に向上しました。

### ✅ 達成された改善
1. **1メッセージ→複数Intent**: 複数の意図を含むメッセージを適切に分割
2. **複数メッセージ→1Intent**: 関連するメッセージを1つのIntentにまとめる
3. **誤抽出の防止**: ラベル・キーワードのみのメッセージは除外
4. **柔軟な粒度**: グループやメッセージの性質に応じて適切な粒度で抽出

### 抽出精度
- **メッセージ/Intent比率**: 0.82〜1.08（柔軟に対応）
- **誤抽出**: 0件
- **適切に除外**: ラベル・キーワードのみのメッセージ

### 次のステップ
- Pipeline 4（類似検索）とPipeline 5（Why/How関係抽出）のテスト
- より大規模なデータセットでの検証
