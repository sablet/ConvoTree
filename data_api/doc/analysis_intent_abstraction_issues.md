# 意図抽出の抽象化問題 - 分析と改善方針

## 実行日時
2025-11-12

## 問題の概要

クラスタ横断上位意図（super_intent）の抽出結果が、過度に抽象的で違和感のある表現になっている。

### 問題のある出力例

```
1. タスク開発アプリの全体構想とメタレベル設計を明確化したい (3件のmeta_intentをカバー)
2. タスク開発アプリにおける思考・情報構造化とLLM/AI連携による高度な情報処理機能を実現したい (6件のmeta_intentをカバー)
19. 個人の健康と満足度を考慮した食生活の効率的な改善と栄養バランスの最適化 (1件のmeta_intentをカバー)
```

これらは以下の問題を抱えている：
- 不自然に長く複雑な文章
- 抽象度が高すぎて具体性が失われている
- 「○○したい」という表現が過度に形式的
- 複数の概念を無理やり1文に詰め込んでいる

## 原因分析

### 1. プロンプトテンプレートの問題

**ファイル**: `templates/intent_grouping_prompt.md`

#### 問題点A: 具体性の過度な要求

```markdown
**CRITICAL**: 抽象的で一般的なグルーピングは禁止です。以下の情報を活用して、**具体的で文脈を反映したグループ名**を作成してください：

1. **source_full_paths**: メッセージの出所（例：「Inbox -> プロジェクトA」）を反映
2. **objective_facts / context**: 具体的な状況や課題を反映
3. **技術・ドメイン**: 特定の技術スタック、ビジネスドメインを明示

**良い例（具体的）**:
- 「チャットアプリのバックエンドAPIの信頼性とパフォーマンスを向上させたい」
- 「データ分析パイプラインにおけるクラスタリング精度を改善したい」
```

この指示により、LLMは：
- できるだけ多くの文脈情報を詰め込もうとする
- 過度に長く複雑な文章を生成する
- 本質的なグルーピングよりも「具体性のアピール」を優先する

#### 問題点B: 階層レベルの考慮不足

プロンプトは「個別意図 → meta_intent」の抽象化を想定しているが、実際には：
- **クラスタ横断（cross-cluster）での抽象化**も同じテンプレートを使用
- `meta_intent → super_intent` の階層で2段階目の抽象化が行われる
- この段階では**既に1段階抽象化された内容**を入力として受け取る

つまり、同じ「具体性を保て」という指示が、異なる抽象度レベルで適用されている。

### 2. 入力データの構造問題

**ファイル**: `scripts/generate_intent_extraction_prompts.py:558-603`

クラスタ横断抽出時のプロンプト構築コード：

```python
def aggregate_cross_cluster_intents(...):
    for i, meta in enumerate(meta_intents):
        parts = [f"{i}."]

        # meta_intent フィールド（必須）
        meta_text = meta.get('meta_intent') or '（未定義）'
        parts.append(f"【意図】{meta_text}")

        # その他のプロパティを追加
        for key, value in meta.items():
            if key in excluded_keys or key == 'meta_intent':
                continue
            # ...
```

#### 問題点：meta_intentの情報密度が高すぎる

**例**:
```
18. 【意図】「タスク開発アプリ」の全活動と情報を集約し、横断的に把握できる全体像を確立したい
    【description】このグループは、「タスク開発アプリ」の核となるビジョンに関する意図を含みます。具体的な課題として、作業記録やタスクが散逸し全体像が見えないこと、過去のメモアプリが単なる情報の垂れ流しになってしまった経験があります。これらの課題に対し、入力時の認知負荷を抑えつつ全体管理の質を向上させること、そして自身の混乱した思考を構造化し、既存ツールにはない付加価値を提供するシステムを構築することを目指しています。
    【rationale】これらの意図は、全て「Inbox -> タスク開発アプリ」という共通のソースパスを持ち、アプリ開発の初期動機や、情報の散逸、全体像の不明瞭さといった根源的な課題を解決し、アプリの価値を最大化するという共通の目的を持っています。
    【source_full_paths】Inbox -> タスク開発アプリ, Inbox -> タスク開発アプリ -> 目的思考２
```

LLMは、この膨大な情報（description, rationale, source_full_paths など）を全て考慮しようとして：
- 複数の概念を無理やり統合
- 冗長で複雑な表現を生成
- 本質的なグルーピングを見失う

### 3. 階層的抽象化の設計ミス

現在の3階層構造：

```
個別意図（intent）
  ↓ 抽象化
meta_intent（クラスタ内での上位意図）
  ↓ さらに抽象化
super_intent（クラスタ横断での最上位意図）
```

#### 問題：各レベルで求められる抽象度が不明確

- **個別意図 → meta_intent**: 具体的な文脈を保持せよ
- **meta_intent → super_intent**: **同じプロンプトで**具体的な文脈を保持せよ

→ 2段階目では既に抽象化済みの内容なのに、さらに「具体性を保て」と指示される矛盾

## 改善方針（修正版）

### 重要な制約条件
- **過去の失敗**: meta_intentのみを入力 → 抽象化しすぎて情報価値を失った
- **現在の問題**: 過剰な情報 → 複雑で焦点不明確な出力
- **理想**: プロジェクト横断で共通テーマは統合、適度な具体性を維持

### A. 階層別プロンプトの分離（推奨）

**実装方針**:
1. `intent_grouping_prompt.md`（個別意図 → meta_intent用）はそのまま
2. 新規作成: `cross_cluster_grouping_prompt.md`（meta_intent → super_intent用）

**新プロンプトの設計原則**:

#### 1. **焦点の明確化**
- ❌ 複数概念の並列列挙: 「○○と△△と□□を実現したい」
- ✅ 単一の核心テーマ: 「○○を実現したい」
- 複数の異なるテーマがある場合は、グループを分割する

#### 2. **適度な抽象化レベル**
- **プロジェクト名は保持**: 文脈として重要（例: 「タスク開発アプリの〜」）
- **プロジェクト横断の統合**: 共通する取り組みは括る（例: 複数プロジェクトでの「AI活用」→ 1つに統合）
- **過度な詳細は省略**: 技術スタックの列挙、詳細な背景説明は不要

#### 3. **情報の選択的利用**
- `meta_intent`本文: 必須、主要な判断材料
- `source_full_paths`: プロジェクト横断判断に利用
- `description`: **要約・キーワード抽出のみ**（全文は渡さない）
- `rationale`: 除外

**出力イメージ**:

```
❌ 悪い例（現状）:
"タスク開発アプリにおける思考・情報構造化とLLM/AI連携による高度な情報処理機能を実現したい"
→ 複数概念の並列、焦点不明確

❌ 過度に抽象化:
"情報処理システムを改善したい"
→ プロジェクト文脈を失い、価値が低下

✅ 良い例（改善後）:
"タスク開発アプリの情報構造化を改善したい"
"タスク開発アプリでのAI活用を推進したい"
→ 2つのテーマに分割、適度な具体性

✅ プロジェクト横断の例:
複数プロジェクトで共通する「開発環境改善」の意図
→ "汎用的な開発環境と品質ツールの改善"
```

### B. meta_intentからの情報抽出の最適化

**修正箇所**: `scripts/generate_intent_extraction_prompts.py:579-603`

**変更方針**:
- `meta_intent`本文: そのまま利用（主要判断材料）
- `source_full_paths`: そのまま利用（プロジェクト横断判断に必要）
- `description`: **要約版を生成**して渡す（詳細は除外、キーワードのみ）
- `rationale`: **完全除外**（グループ化の経緯は不要）
- `aggregate_status`: そのまま利用

**実装案**:

```python
def summarize_description(description: str, max_keywords: int = 5) -> str:
    """
    descriptionから重要なキーワードのみを抽出

    例:
    入力: "このグループは、「タスク開発アプリ」の核となるビジョンに関する意図を含みます。
          具体的な課題として、作業記録やタスクが散逸し全体像が見えないこと..."
    出力: "ビジョン、作業記録の散逸、全体像、認知負荷"
    """
    # 実装: LLMまたはTF-IDFでキーワード抽出
    pass

# プロンプト構築時
for i, meta in enumerate(meta_intents):
    parts = [f"{i}."]

    # meta_intent本文（必須）
    meta_text = meta.get('meta_intent') or '（未定義）'
    parts.append(f"【意図】{meta_text}")

    # source_full_paths（プロジェクト横断判断に必要）
    if meta.get('source_full_paths'):
        paths = ', '.join(meta['source_full_paths'])
        parts.append(f"【プロジェクト】{paths}")

    # description（要約版のみ）
    if meta.get('description'):
        summary = summarize_description(meta['description'])
        if summary:
            parts.append(f"【補足】{summary}")

    # rationale, covered_intent_idsなどは除外
```

### C. 文体・長さ・統合ルールの制約追加

**新プロンプトに追加する制約**:

```markdown
## 出力制約

### 1. 簡潔性と焦点
- **文字数**: super_intentは最大30文字以内（日本語）
- **単一テーマ**: 1つのグループは1つの核心的なテーマに絞る
- **分割判断**: 複数の異なるテーマがある場合、無理に統合せず分割する

### 2. 禁止表現
❌ 「○○と△△と□□を××したい」（並列列挙）
❌ 「○○における△△とAI連携による□□の実現」（過度な修飾）
❌ 「高度な〜」「包括的な〜」（抽象的修飾語の濫用）

### 3. 推奨表現パターン
✅ プロジェクト特化型:
   - 「[プロジェクト名]の[課題]を[方向性]したい」
   - 例: 「タスク開発アプリの情報構造化を改善したい」

✅ プロジェクト横断型:
   - 「[汎用的活動]における[課題]を[方向性]したい」
   - 例: 「開発環境の品質ツールを改善したい」

### 4. プロジェクト横断の統合ルール
- source_full_pathsが複数の異なるプロジェクトにまたがる場合:
  - 共通する本質的なテーマを抽出
  - プロジェクト名は省略し、汎用的な表現にする
  - 例: 「タスク開発アプリのAI活用」「アルゴトレードのAI活用」
    → 「開発プロジェクトにおけるAI活用を推進したい」

- 同一プロジェクト内の統合:
  - プロジェクト名は保持
  - 例: 複数の「タスク開発アプリ」関連
    → 「タスク開発アプリの[統一テーマ]を実現したい」
```

### D. 検証と反復改善

**実装ステップ**:
1. 新プロンプトテンプレート作成
2. 入力データの情報量削減
3. 既存データで再実行し、出力を比較
4. 必要に応じてプロンプトを微調整

## 次のアクション

1. [ ] `templates/cross_cluster_grouping_prompt.md` を新規作成
2. [ ] `scripts/generate_intent_extraction_prompts.py` の `aggregate_cross_cluster_intents()` を修正
3. [ ] 既存データで再実行してA/Bテスト
4. [ ] 出力の質的評価とフィードバック

## 補足: プロンプトの哲学的問題

現在のプロンプトは「具体性 = 良い」という前提に立っているが、階層的抽象化においては：

- **下層（個別意図）**: 具体性が重要
- **中層（meta_intent）**: 文脈を保ちつつ抽象化
- **上層（super_intent）**: 本質的なテーマへの統合が重要

上層で過度に具体性を保とうとすると、かえって本質を見失う。
適切な抽象化階層の設計が必要。
